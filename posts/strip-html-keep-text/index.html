<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.68.3" />

  <title>How to Strip HTML Tags but Keep their Text &middot; My Blog</title>

  <meta name="description" content="" />

  
  <meta property="og:locale" content="en-us"/>

  
  <meta property="og:image" content="https://emptyheap2019.github.io/images/profile.png">

  
  <meta property="og:type" content="blog"/>
  <meta property="og:site_name" content="My Blog"/><meta property="og:title" content="How to Strip HTML Tags but Keep their Text"/>
  <meta property="og:url" content="https://emptyheap2019.github.io/posts/strip-html-keep-text/"/>
  <meta property="og:description" content="Let&rsquo;s consider the following problem. We have some HTML which comes from user-input."/>

  <script type="application/ld+json">
  {
    "@context" : "http://schema.org",
    "@type" : "Blog",
    "name": "My Blog",
    "url" : "https://emptyheap2019.github.io/",
    "image": "https://emptyheap2019.github.io/images/profile.png",
    "description": "Hi, welcome to the place where I write stuff on the Internet!"
  }
  </script>

  


  <link type="text/css"
        rel="stylesheet"
        href="https://emptyheap2019.github.io/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="https://emptyheap2019.github.io/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="https://emptyheap2019.github.io/css/hyde.css">

  


  

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <img src="https://emptyheap2019.github.io/images/profile.png" class="img-circle img-headshot center" alt="Profile Picture">
        </div>
        
      

      <h1>My Blog</h1>

      
      <p class="lead">Hi, welcome to the place where I write stuff on the Internet!</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://emptyheap2019.github.io/">Home</a>
        </li>
        <li>
          <a href="/posts/"> Posts </a>
        </li><li>
          <a href="/about/"> About </a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="#" rel="me" title="Linkedin">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
      
      <a href="#" rel="me" title="GitHub">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="#" rel="me" title="Twitter">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1>How to Strip HTML Tags but Keep their Text</h1>

  <div class="post-date">
    <time datetime="2020-04-02T16:12:33-0400">Apr 2, 2020</time> · 4 min read
  </div>

  <p>Let&rsquo;s consider the following problem. We have some HTML which comes from user-input. The HTML itself cannot be trusted. We want to remove certain elements from this HTML, but keep the underlying text content so that it can be safe for displaying on our own site. This also means we need to strip any unwanted attributes from certain tags.</p>
<p>This problem isn&rsquo;t as simple as it appears at first. Because in order to remove specific HTML elements from the DOM tree, but keep the text inside them we would have to recursively search the DOM tree, find the unwated nodes, retain their text nodes, remove them from the tree, and insert the text nodes back into the removed node&rsquo;s parent.</p>
<h2 id="walking-the-dom-tree-depth-first-in-order-recursion">Walking the DOM Tree (Depth-First In Order Recursion)</h2>
<p>To do this in a more straight-forward fashion I&rsquo;m simply going to implement a generator that extends <code>DOMDocument</code>, which can search the tree using <strong>Depth-First In Order Traversal</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">    class HTMLFixer extends DOMDocument {
        public function walk(DOMNode $node, $skipParent = false) {
            if (!$skipParent) {
                yield $node;
            }
            if ($node-&gt;hasChildNodes()) {
                foreach ($node-&gt;childNodes as $n) {
                    yield from $this-&gt;walk($n);
                }
            }
        }
    }
</code></pre></div><p>Next we need a way to find the unwanted nodes and remove them without discarding their text. The simplest way to do this is to build a list of tags to be removed from inside the recursion loop and then remove them later using <code>DOMNode::insertBefore()</code> to append the text nodes back up the tree. That way we can remove those nodes later <em>without</em> any side effects.</p>
<p>To do this let&rsquo;s add a general <code>stripTags()</code> method to our extended <code>HTMLFixer</code> class above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">    public function stripTags(DOMNode $node) {
        $change = $remove = [];

        /* Walk the entire tree to build a list of things that need removed */
        foreach($this-&gt;walk($node) as $n) {
            if ($n instanceof DOMText || $n instanceof DOMDocument) {
                continue;
            }
            $this-&gt;stripAttributes($n); // strips all node attributes not allowed
            $this-&gt;forceAttributes($n); // forces any required attributes
            if (!in_array($n-&gt;nodeName, $this-&gt;allowedTags, true)) {
                // track the disallowed node for removal
                $remove[] = $n;
                // we take all of its child nodes for modification later
                foreach($n-&gt;childNodes as $child) {
                    $change[] = [$child, $n];
                }
            }
        }

        /* Go through the list of changes first so we don&#39;t break the
           referential integrity of the tree */
        foreach($change as list($a, $b)) {
            $b-&gt;parentNode-&gt;insertBefore($a, $b);
        }

        /* Now we can safely remove the old nodes */
        foreach($remove as $a) {
            if ($a-&gt;parentNode) {
                $a-&gt;parentNode-&gt;removeChild($a);
            }
        }
    }
</code></pre></div><p>Deferring the move of the node makes sure we don&rsquo;t break <code>parentNode</code> reference when the deeper node is the one that&rsquo;s allowed, but its parent is not in the allowed tags list for example.</p>
<p>Here&rsquo;s the complete solution.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">    class HTMLFixer extends DOMDocument {
    
        protected static $defaultAllowedTags = [
            &#39;p&#39;,
            &#39;h1&#39;,
            &#39;h2&#39;,
            &#39;h3&#39;,
            &#39;h4&#39;,
            &#39;h5&#39;,
            &#39;h6&#39;,
            &#39;pre&#39;,
            &#39;code&#39;,
            &#39;blockquote&#39;,
            &#39;q&#39;,
            &#39;strong&#39;,
            &#39;em&#39;,
            &#39;del&#39;,
            &#39;img&#39;,
            &#39;a&#39;,
            &#39;table&#39;,
            &#39;thead&#39;,
            &#39;tbody&#39;,
            &#39;tfoot&#39;,
            &#39;tr&#39;,
            &#39;th&#39;,
            &#39;td&#39;,
            &#39;ul&#39;,
            &#39;ol&#39;,
            &#39;li&#39;,
        ];
        protected static $defaultAllowedAttributes = [
            &#39;a&#39;   =&gt; [&#39;href&#39;],
            &#39;img&#39; =&gt; [&#39;src&#39;],
            &#39;pre&#39; =&gt; [&#39;class&#39;],
        ];
        protected static $defaultForceAttributes = [
            &#39;a&#39; =&gt; [&#39;target&#39; =&gt; &#39;_blank&#39;],
        ];

        protected $allowedTags       = [];
        protected $allowedAttributes = [];
        protected $forceAttributes   = [];

        public function __construct($version = null, $encoding = null, $allowedTags = [],
                                    $allowedAttributes = [], $forceAttributes = []) {
            $this-&gt;setAllowedTags($allowedTags ?: static::$defaultAllowedTags);
            $this-&gt;setAllowedAttributes($allowedAttributes ?: static::$defaultAllowedAttributes);
            $this-&gt;setForceAttributes($forceAttributes ?: static::$defaultForceAttributes);
            parent::__construct($version, $encoding);
        }

        public function setAllowedTags(Array $tags) {
            $this-&gt;allowedTags = $tags;
        }

        public function setAllowedAttributes(Array $attributes) {
            $this-&gt;allowedAttributes = $attributes;
        }

        public function setForceAttributes(Array $attributes) {
            $this-&gt;forceAttributes = $attributes;
        }

        public function getAllowedTags() {
            return $this-&gt;allowedTags;
        }

        public function getAllowedAttributes() {
            return $this-&gt;allowedAttributes;
        }

        public function getForceAttributes() {
            return $this-&gt;forceAttributes;
        }

        public function saveHTML(DOMNode $node = null) {
            if (!$node) {
                $node = $this;
            }
            $this-&gt;stripTags($node);
            return parent::saveHTML($node);
        }

        protected function stripTags(DOMNode $node) {
            $change = $remove = [];
            foreach($this-&gt;walk($node) as $n) {
                if ($n instanceof DOMText || $n instanceof DOMDocument) {
                    continue;
                }
                $this-&gt;stripAttributes($n);
                $this-&gt;forceAttributes($n);
                if (!in_array($n-&gt;nodeName, $this-&gt;allowedTags, true)) {
                    $remove[] = $n;
                    foreach($n-&gt;childNodes as $child) {
                        $change[] = [$child, $n];
                    }
                }
            }
            foreach($change as list($a, $b)) {
                $b-&gt;parentNode-&gt;insertBefore($a, $b);
            }
            foreach($remove as $a) {
                if ($a-&gt;parentNode) {
                    $a-&gt;parentNode-&gt;removeChild($a);
                }
            }
        }

        protected function stripAttributes(DOMNode $node) {
            $attributes = $node-&gt;attributes;
            $len = $attributes-&gt;length;
            for ($i = $len - 1; $i &gt;= 0; $i--) {
                $attr = $attributes-&gt;item($i);
                if (!isset($this-&gt;allowedAttributes[$node-&gt;nodeName]) ||
                    !in_array($attr-&gt;name, $this-&gt;allowedAttributes[$node-&gt;nodeName], true)) {
                    $node-&gt;removeAttributeNode($attr);
                }
            }
        }

        protected function forceAttributes(DOMNode $node) {
            if (isset($this-&gt;forceAttributes[$node-&gt;nodeName])) {
                foreach ($this-&gt;forceAttributes[$node-&gt;nodeName] as $attribute =&gt; $value) {
                    $node-&gt;setAttribute($attribute, $value);
                }
            }
        }

        protected function walk(DOMNode $node, $skipParent = false) {
            if (!$skipParent) {
                yield $node;
            }
            if ($node-&gt;hasChildNodes()) {
                foreach ($node-&gt;childNodes as $n) {
                    yield from $this-&gt;walk($n);
                }
            }
        }
    
    }
</code></pre></div>
</div>


  </main>

  <footer>
  <div class="copyright">
    &copy; emptyheap 2020 · 
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>

  

  
</body>
</html>
